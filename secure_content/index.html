<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Content Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            /* Mobile screenshot prevention */
            -webkit-appearance: none;
            pointer-events: auto;
            overscroll-behavior: none;
        }
        
        /* Prevent mobile screenshot overlays */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: -1;
            pointer-events: none;
        }
        
        /* Mobile-specific protections */
        @media only screen and (max-width: 768px) {
            body {
                overflow-x: hidden;
                touch-action: pan-y;
            }
            
            .secure-content {
                padding: 15px;
                margin: 10px;
                font-size: 16px;
                line-height: 1.5;
            }
            
            .timer-display {
                top: 5px;
                right: 5px;
                padding: 8px 12px;
                font-size: 14px;
            }
        }
        
        .secure-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
            pointer-events: auto;
        }
        
        .timer-display {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 9999;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 10000;
        }
        
        /* Prevent screenshot overlay */
        .screenshot-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 10001;
        }
        
        /* Hide content when dev tools are open */
        .devtools-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 10002;
        }
    </style>
</head>
<body>
    <div class="timer-display" id="timer">Time remaining: 5:00</div>
    
    <div class="secure-content" id="content">
        <h1>Secure Content</h1>
        <p>This is protected content that will be automatically removed after the time limit.</p>
        <p>Screenshot prevention and navigation monitoring are active.</p>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
        <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </div>
    
    <div class="overlay" id="expiredOverlay">
        <div>Content has expired and is no longer accessible</div>
    </div>
    
    <div class="screenshot-overlay" id="screenshotOverlay">
        <div>Screenshot attempt detected - Content temporarily hidden</div>
    </div>
    
    <div class="devtools-warning" id="devtoolsWarning">
        <div>Developer tools detected - Content hidden for security</div>
    </div>

    <script>
        class SecureContentViewer {
            constructor(timeLimit = 5 * 60 * 1000, serverUrl = 'secure_server.php') {
                this.timeLimit = timeLimit;
                this.serverUrl = serverUrl;
                this.startTime = Date.now();
                this.isExpired = false;
                this.screenshotBlocked = false;
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                this.lastTouch = 0;
                this.gestureDetected = false;
                this.sessionToken = null;
                this.serverValidationInterval = null;
                
                this.init();
            }
            
            async init() {
                // Initialize server-side session first
                await this.initializeServerSession();
                
                this.startTimer();
                this.setupScreenshotPrevention();
                this.setupNavigationProtection();
                this.setupDevToolsDetection();
                this.setupVisibilityChange();
                
                // Mobile-specific protections
                if (this.isMobile) {
                    this.setupMobileProtection();
                }
                
                // Start server validation
                this.startServerValidation();
            }
            
            startTimer() {
                const timerElement = document.getElementById('timer');
                
                const updateTimer = () => {
                    if (this.isExpired) return;
                    
                    const elapsed = Date.now() - this.startTime;
                    const remaining = Math.max(0, this.timeLimit - elapsed);
                    
                    if (remaining === 0) {
                        this.expireContent();
                        return;
                    }
                    
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    timerElement.textContent = `Time remaining: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                };
                
                updateTimer();
                this.timerInterval = setInterval(updateTimer, 1000);
            }
            
            expireContent() {
                this.isExpired = true;
                clearInterval(this.timerInterval);
                
                if (this.serverValidationInterval) {
                    clearInterval(this.serverValidationInterval);
                }
                
                // Expire server session
                this.expireServerSession();
                
                // Hide content and show expired message
                document.getElementById('content').style.display = 'none';
                document.getElementById('timer').style.display = 'none';
                document.getElementById('expiredOverlay').style.display = 'flex';
                
                // Clear the page content after a delay
                setTimeout(() => {
                    document.body.innerHTML = '<div style="text-align:center;padding:50px;font-size:24px;">Content no longer available</div>';
                }, 2000);
            }
            
            setupScreenshotPrevention() {
                // Disable common screenshot shortcuts
                document.addEventListener('keydown', (e) => {
                    // Print Screen, Alt+Print Screen, Windows+Print Screen
                    if (e.key === 'PrintScreen' || 
                        (e.altKey && e.key === 'PrintScreen') ||
                        (e.metaKey && e.shiftKey && e.key === '3') || // Mac screenshot
                        (e.metaKey && e.shiftKey && e.key === '4') || // Mac area screenshot
                        (e.ctrlKey && e.shiftKey && e.key === 'S')) { // Some screenshot tools
                        
                        e.preventDefault();
                        this.showScreenshotWarning();
                        return false;
                    }
                    
                    // Disable F12, Ctrl+Shift+I (Dev Tools)
                    if (e.key === 'F12' || 
                        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                        (e.ctrlKey && e.key === 'U')) {
                        e.preventDefault();
                        return false;
                    }
                });
                
                // Disable right-click context menu
                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    return false;
                });
                
                // Monitor for potential screenshot tools
                this.setupScreenshotDetection();
            }
            
            showScreenshotWarning() {
                const overlay = document.getElementById('screenshotOverlay');
                overlay.style.display = 'flex';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 3000);
            }
            
            setupScreenshotDetection() {
                // Monitor for sudden focus changes that might indicate screenshot tools
                let focusLost = false;
                
                window.addEventListener('blur', () => {
                    focusLost = true;
                    // Temporarily hide content when window loses focus
                    document.getElementById('content').style.visibility = 'hidden';
                });
                
                window.addEventListener('focus', () => {
                    if (focusLost) {
                        setTimeout(() => {
                            if (!this.isExpired) {
                                document.getElementById('content').style.visibility = 'visible';
                            }
                        }, 500);
                        focusLost = false;
                    }
                });
            }
            
            setupMobileProtection() {
                // Detect mobile screenshot gestures
                this.setupTouchGestureDetection();
                this.setupMobileScreenshotPrevention();
                this.setupAppSwitchingDetection();
                this.setupOrientationProtection();
                this.setupMobileDevToolsDetection();
            }
            
            setupTouchGestureDetection() {
                let touchStart = null;
                let touchCount = 0;
                
                // Monitor for suspicious touch patterns that might indicate screenshots
                document.addEventListener('touchstart', (e) => {
                    touchCount = e.touches.length;
                    touchStart = Date.now();
                    
                    // Detect multi-finger gestures (common in screenshot combinations)
                    if (touchCount >= 3) {
                        this.handleSuspiciousActivity('Multi-touch gesture detected');
                    }
                }, { passive: false });
                
                document.addEventListener('touchend', (e) => {
                    const touchDuration = Date.now() - touchStart;
                    
                    // Very quick multi-touch could be screenshot attempt
                    if (touchCount >= 2 && touchDuration < 200) {
                        this.handleSuspiciousActivity('Quick multi-touch detected');
                    }
                });
                
                // Detect hardware buttons (limited browser support)
                document.addEventListener('keydown', (e) => {
                    // These key codes are not reliably detected in mobile browsers
                    // Keeping for desktop compatibility and future browser support
                    const suspiciousKeys = ['PrintScreen', 'VolumeDown', 'VolumeUp', 'Power'];
                    
                    if (suspiciousKeys.includes(e.key) || e.code === 'PrintScreen') {
                        e.preventDefault();
                        this.handleSuspiciousActivity(`Hardware key detected: ${e.key || e.code}`);
                        return false;
                    }
                });
            }
            
            setupMobileScreenshotPrevention() {
                // Prevent long press context menus
                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    return false;
                });
                
                // Note: Screenshot detection APIs are not widely supported yet
                // This section is commented out as the API doesn't exist in current browsers
                /*
                if ('getScreenshots' in navigator) {
                    setInterval(() => {
                        try {
                            navigator.getScreenshots().then(() => {
                                this.handleSuspiciousActivity('Screenshot API detected');
                            }).catch(() => {
                                // API not available or no screenshots
                            });
                        } catch (e) {
                            // API not supported
                        }
                    }, 2000);
                }
                */
                
                // iOS specific - detect force touch (3D Touch)
                document.addEventListener('touchstart', (e) => {
                    // Check if force property exists and is above normal threshold
                    for (let i = 0; i < e.touches.length; i++) {
                        const touch = e.touches[i];
                        if (touch.force && touch.force > 0.7) {
                            this.handleSuspiciousActivity('Force touch detected');
                            break;
                        }
                    }
                }, { passive: false });
            }
            
            setupAppSwitchingDetection() {
                let lastVisibilityChange = Date.now();
                
                // Enhanced visibility change detection for mobile
                document.addEventListener('visibilitychange', () => {
                    const now = Date.now();
                    
                    if (document.hidden) {
                        // Hide content immediately when app goes to background
                        document.getElementById('content').style.display = 'none';
                        
                        // If quick app switching (common during screenshots), expire faster
                        if (now - lastVisibilityChange < 2000) {
                            setTimeout(() => {
                                if (!this.isExpired) {
                                    this.expireContent();
                                }
                            }, 5000); // Expire in 5 seconds for suspicious activity
                        }
                    } else {
                        // Show content again when returning to app
                        if (!this.isExpired) {
                            document.getElementById('content').style.display = 'block';
                        }
                    }
                    
                    lastVisibilityChange = now;
                });
                
                // Page focus/blur events for mobile browsers
                window.addEventListener('blur', () => {
                    document.getElementById('content').style.opacity = '0';
                });
                
                window.addEventListener('focus', () => {
                    if (!this.isExpired) {
                        document.getElementById('content').style.opacity = '1';
                    }
                });
            }
            
            setupOrientationProtection() {
                // Monitor orientation changes that might indicate screenshot attempts
                const handleOrientationChange = () => {
                    // Temporarily hide content during orientation change
                    document.getElementById('content').style.visibility = 'hidden';
                    
                    setTimeout(() => {
                        if (!this.isExpired) {
                            document.getElementById('content').style.visibility = 'visible';
                        }
                    }, 1000);
                };
                
                // Modern orientation API
                if (screen.orientation && screen.orientation.addEventListener) {
                    screen.orientation.addEventListener('change', handleOrientationChange);
                }
                
                // Legacy orientation change detection
                window.addEventListener('orientationchange', handleOrientationChange);
                
                // Additional resize detection for orientation changes
                let lastWidth = window.innerWidth;
                let lastHeight = window.innerHeight;
                
                window.addEventListener('resize', () => {
                    const currentWidth = window.innerWidth;
                    const currentHeight = window.innerHeight;
                    
                    // Check if it's likely an orientation change (width/height swap)
                    if (Math.abs(currentWidth - lastHeight) < 50 && Math.abs(currentHeight - lastWidth) < 50) {
                        handleOrientationChange();
                    }
                    
                    lastWidth = currentWidth;
                    lastHeight = currentHeight;
                });
            }
            
            setupMobileDevToolsDetection() {
                // Mobile browser dev tools detection (limited effectiveness)
                let devToolsOpen = false;
                
                const checkDevTools = () => {
                    const startTime = performance.now();
                    
                    // Use a more reliable console detection method
                    const devtools = {
                        toString: function() {
                            devToolsOpen = true;
                            return '';
                        }
                    };
                    
                    try {
                        console.log('%c%s', '', devtools);
                    } catch (e) {
                        // Console access denied or error
                    }
                    
                    const endTime = performance.now();
                    
                    if (devToolsOpen || (endTime - startTime > 10)) {
                        if (!this.gestureDetected) {
                            this.gestureDetected = true;
                            this.handleSuspiciousActivity('Developer console access detected');
                            setTimeout(() => { this.gestureDetected = false; }, 5000);
                        }
                    }
                    
                    devToolsOpen = false;
                };
                
                setInterval(checkDevTools, 2000);
                
                // Detect significant viewport changes that might indicate dev tools
                let lastViewportWidth = window.innerWidth;
                let lastViewportHeight = window.innerHeight;
                
                const checkViewport = () => {
                    const currentWidth = window.innerWidth;
                    const currentHeight = window.innerHeight;
                    
                    const widthChange = Math.abs(currentWidth - lastViewportWidth);
                    const heightChange = Math.abs(currentHeight - lastViewportHeight);
                    
                    // Significant viewport change without orientation change might indicate dev tools
                    if ((widthChange > 100 || heightChange > 100) && !this.gestureDetected) {
                        this.handleSuspiciousActivity('Significant viewport change detected');
                    }
                    
                    lastViewportWidth = currentWidth;
                    lastViewportHeight = currentHeight;
                };
                
                setInterval(checkViewport, 1000);
            }
            
            handleSuspiciousActivity(reason) {
                if (this.isExpired) return;
                
                console.log('Suspicious activity:', reason);
                
                // Show warning and temporarily hide content
                this.showScreenshotWarning();
                
                // Hide content for longer on mobile
                document.getElementById('content').style.display = 'none';
                
                setTimeout(() => {
                    if (!this.isExpired) {
                        document.getElementById('content').style.display = 'block';
                    }
                }, this.isMobile ? 5000 : 3000);
                
                // Reduce remaining time as penalty
                this.timeLimit = Math.max(30000, this.timeLimit - 60000); // Reduce by 1 minute, minimum 30 seconds
                
                // Report to server
                this.reportSuspiciousActivity(reason, 'Client-side detection');
            }
            
            // Server-side integration methods
            async initializeServerSession() {
                try {
                    const response = await fetch(this.serverUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `action=generate_token&time_limit=${Math.floor(this.timeLimit / 1000)}&user_id=viewer_${Date.now()}`
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.sessionToken = data.token;
                        console.log('Server session initialized');
                    } else {
                        console.error('Failed to initialize server session:', data.error);
                        // Continue with client-only protection
                    }
                } catch (error) {
                    console.error('Server connection failed:', error);
                    // Continue with client-only protection
                }
            }
            
            startServerValidation() {
                if (!this.sessionToken) return;
                
                // Validate token with server every 30 seconds
                this.serverValidationInterval = setInterval(async () => {
                    try {
                        const response = await fetch(this.serverUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `action=validate_token&token=${encodeURIComponent(this.sessionToken)}`
                        });
                        
                        const data = await response.json();
                        
                        if (!data.valid) {
                            console.log('Server session invalid:', data.reason);
                            this.expireContent();
                            return;
                        }
                        
                        // Update remaining time from server
                        if (data.remaining_time !== undefined) {
                            const serverTimeRemaining = data.remaining_time * 1000;
                            const clientTimeRemaining = Math.max(0, this.timeLimit - (Date.now() - this.startTime));
                            
                            // Use the shorter of server or client time
                            if (serverTimeRemaining < clientTimeRemaining) {
                                this.timeLimit = (Date.now() - this.startTime) + serverTimeRemaining;
                            }
                        }
                        
                    } catch (error) {
                        console.error('Server validation failed:', error);
                        // Continue with client-only timing
                    }
                }, 30000);
            }
            
            async reportSuspiciousActivity(activity, details = '') {
                if (!this.sessionToken) return;
                
                try {
                    const response = await fetch(this.serverUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `action=report_suspicious&token=${encodeURIComponent(this.sessionToken)}&activity=${encodeURIComponent(activity)}&details=${encodeURIComponent(details)}`
                    });
                    
                    const data = await response.json();
                    
                    if (data.action === 'session_expired') {
                        console.log('Session expired due to suspicious activity');
                        this.expireContent();
                    }
                    
                } catch (error) {
                    console.error('Failed to report suspicious activity:', error);
                }
            }
            
            async expireServerSession() {
                if (!this.sessionToken) return;
                
                try {
                    await fetch(this.serverUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `action=expire_session&token=${encodeURIComponent(this.sessionToken)}`
                    });
                } catch (error) {
                    console.error('Failed to expire server session:', error);
                }
            }
            
            setupNavigationProtection() {
                // Warn before leaving the page
                window.addEventListener('beforeunload', (e) => {
                    if (!this.isExpired) {
                        e.preventDefault();
                        e.returnValue = 'Content will be permanently inaccessible if you leave this page.';
                        return e.returnValue;
                    }
                });
                
                // Handle page visibility changes
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !this.isExpired) {
                        // Page is hidden, start a shorter timer
                        setTimeout(() => {
                            if (document.hidden && !this.isExpired) {
                                this.expireContent();
                            }
                        }, 30000); // 30 seconds when hidden
                    }
                });
            }
            
            setupDevToolsDetection() {
                // Basic dev tools detection
                let devtools = {
                    open: false,
                    orientation: null
                };
                
                const threshold = 160;
                
                setInterval(() => {
                    if (window.outerHeight - window.innerHeight > threshold || 
                        window.outerWidth - window.innerWidth > threshold) {
                        if (!devtools.open) {
                            devtools.open = true;
                            document.getElementById('devtoolsWarning').style.display = 'flex';
                            document.getElementById('content').style.display = 'none';
                        }
                    } else {
                        if (devtools.open) {
                            devtools.open = false;
                            document.getElementById('devtoolsWarning').style.display = 'none';
                            if (!this.isExpired) {
                                document.getElementById('content').style.display = 'block';
                            }
                        }
                    }
                }, 500);
            }
            
            setupVisibilityChange() {
                // Additional protection for tab switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        document.getElementById('content').style.filter = 'blur(10px)';
                    } else {
                        if (!this.isExpired) {
                            document.getElementById('content').style.filter = 'none';
                        }
                    }
                });
            }
        }
        
        // Initialize the secure viewer with server integration
        // Change 'secure_server.php' to your actual server endpoint
        const secureViewer = new SecureContentViewer(5 * 60 * 1000, 'secure_server.php');
        
        // Additional security: Clear content if JavaScript is disabled
        document.write('<noscript><div style="text-align:center;padding:50px;">JavaScript must be enabled to view this content.</div></noscript>');
    </script>
</body>
</html>